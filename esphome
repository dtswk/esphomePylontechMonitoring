#esphome content

esphome:
  name: pylontech-monitor
  friendly_name: Pylontech Monitor

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf


# Enable Home Assistant API
api:
  encryption:
    key: "<insert key here>"

ota:
  - platform: esphome
    password: "<insert password here>"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Pylontech-Monitor"
    password: "<insert password here>"

captive_portal:

# --- Web Server ---
# This creates the web interface.
# We use version 3 for the modern UI with built-in Log Viewer.
web_server:
  port: 80
  version: 3

# --- UART Configuration ---
#R5Stack documentation and testing is rx 5 and tx 6, ignore the label on the RS232

uart:
  - id: uart_bus
    tx_pin: GPIO6
    rx_pin: GPIO5
    baud_rate: 115200
    stop_bits: 1
    parity: NONE
    data_bits: 8
    rx_buffer_size: 4096 # Increased buffer to prevent data drops during large updates with large battery banks.  Without this default is 1500 which will fail on large banks
    debug:
      direction: BOTH
      dummy_receiver: true
      # Uncomment if needed for full insight into commands, disable normally due to the load on the ESP32
      #sequence:
      #  - lambda: UARTDebug::log_string(direction, bytes);

# Enable logging (Required for the Web Server Log Viewer)
logger:
  level: INFO #DEBUG if you need detailed info
  baud_rate: 0 # Disable logging over USB Serial if you want to rely purely on WiFi logs

# Keep the robust external component to prevent "invalid bat_num" errors
# external_components:
#   - source: github://myhomeiot/esphome-components
#     components: [pylontech]

# --- Pylontech Component ---
pylontech:
  id: pylontech0
  uart_id: uart_bus
  # Adjust poling as desired
  update_interval: 600s

# --- Sensors ---
#Below is 15 batteries adjust as needed

sensor:
  - platform: pylontech
    battery: 1
    voltage:
      name: "Battery1 Voltage"
    current:
      name: "Battery1 Current"
    coulomb:
      name: "Battery1 SoC"
    temperature:
      name: "Battery1 Temp Average"
    voltage_low:
      name: "Battery1 Lowest Cell Voltage"
    voltage_high:
      name: "Battery1 Highest Cell Voltage"

  - platform: pylontech
    battery: 2
    voltage:
      name: "Battery2 Voltage"
    current:
      name: "Battery2 Current"
    coulomb:
      name: "Battery2 SoC"
    temperature:
      name: "Battery2 Temp Average"
    voltage_low:
      name: "Battery2 Lowest Cell Voltage"
    voltage_high:
      name: "Battery2 Highest Cell Voltage"

  - platform: pylontech
    battery: 3
    voltage:
      name: "Battery3 Voltage"
    current:
      name: "Battery3 Current"
    coulomb:
      name: "Battery3 SoC"
    temperature:
      name: "Battery3 Temp Average"
    voltage_low:
      name: "Battery3 Lowest Cell Voltage"
    voltage_high:
      name: "Battery3 Highest Cell Voltage"

  - platform: pylontech
    battery: 4
    voltage:
      name: "Battery4 Voltage"
    current:
      name: "Battery4 Current"
    coulomb:
      name: "Battery4 SoC"
    temperature:
      name: "Battery4 Temp Average"
    voltage_low:
      name: "Battery4 Lowest Cell Voltage"
    voltage_high:
      name: "Battery4 Highest Cell Voltage"

  - platform: pylontech
    battery: 5
    voltage:
      name: "Battery5 Voltage"
    current:
      name: "Battery5 Current"
    coulomb:
      name: "Battery5 SoC"
    temperature:
      name: "Battery5 Temp Average"
    voltage_low:
      name: "Battery5 Lowest Cell Voltage"
    voltage_high:
      name: "Battery5 Highest Cell Voltage"

  - platform: pylontech
    battery: 6
    voltage:
      name: "Battery6 Voltage"
    current:
      name: "Battery6 Current"
    coulomb:
      name: "Battery6 SoC"
    temperature:
      name: "Battery6 Temp Average"
    voltage_low:
      name: "Battery6 Lowest Cell Voltage"
    voltage_high:
      name: "Battery6 Highest Cell Voltage"

  - platform: pylontech
    battery: 7
    voltage:
      name: "Battery7 Voltage"
    current:
      name: "Battery7 Current"
    coulomb:
      name: "Battery7 SoC"
    temperature:
      name: "Battery7 Temp Average"
    voltage_low:
      name: "Battery7 Lowest Cell Voltage"
    voltage_high:
      name: "Battery7 Highest Cell Voltage"

  - platform: pylontech
    battery: 8
    voltage:
      name: "Battery8 Voltage"
    current:
      name: "Battery8 Current"
    coulomb:
      name: "Battery8 SoC"
    temperature:
      name: "Battery8 Temp Average"
    voltage_low:
      name: "Battery8 Lowest Cell Voltage"
    voltage_high:
      name: "Battery8 Highest Cell Voltage"

  - platform: pylontech
    battery: 9
    voltage:
      name: "Battery9 Voltage"
    current:
      name: "Battery9 Current"
    coulomb:
      name: "Battery9 SoC"
    temperature:
      name: "Battery9 Temp Average"
    voltage_low:
      name: "Battery9 Lowest Cell Voltage"
    voltage_high:
      name: "Battery9 Highest Cell Voltage"

  - platform: pylontech
    battery: 10
    voltage:
      name: "Battery10 Voltage"
    current:
      name: "Battery10 Current"
    coulomb:
      name: "Battery10 SoC"
    temperature:
      name: "Battery10 Temp Average"
    voltage_low:
      name: "Battery10 Lowest Cell Voltage"
    voltage_high:
      name: "Battery10 Highest Cell Voltage"

  - platform: pylontech
    battery: 11
    voltage:
      name: "Battery11 Voltage"
    current:
      name: "Battery11 Current"
    coulomb:
      name: "Battery11 SoC"
    temperature:
      name: "Battery11 Temp Average"
    voltage_low:
      name: "Battery11 Lowest Cell Voltage"
    voltage_high:
      name: "Battery11 Highest Cell Voltage"

  - platform: pylontech
    battery: 12
    voltage:
      name: "Battery12 Voltage"
    current:
      name: "Battery12 Current"
    coulomb:
      name: "Battery12 SoC"
    temperature:
      name: "Battery12 Temp Average"
    voltage_low:
      name: "Battery12 Lowest Cell Voltage"
    voltage_high:
      name: "Battery12 Highest Cell Voltage"

  - platform: pylontech
    battery: 13
    voltage:
      name: "Battery13 Voltage"
    current:
      name: "Battery13 Current"
    coulomb:
      name: "Battery13 SoC"
    temperature:
      name: "Battery13 Temp Average"
    voltage_low:
      name: "Battery13 Lowest Cell Voltage"
    voltage_high:
      name: "Battery13 Highest Cell Voltage"

  - platform: pylontech
    battery: 14
    voltage:
      name: "Battery14 Voltage"
    current:
      name: "Battery14 Current"
    coulomb:
      name: "Battery14 SoC"
    temperature:
      name: "Battery14 Temp Average"
    voltage_low:
      name: "Battery14 Lowest Cell Voltage"
    voltage_high:
      name: "Battery14 Highest Cell Voltage"

  - platform: pylontech
    battery: 15
    voltage:
      name: "Battery15 Voltage"
    current:
      name: "Battery15 Current"
    coulomb:
      name: "Battery15 SoC"
    temperature:
      name: "Battery15 Temp Average"
    voltage_low:
      name: "Battery15 Lowest Cell Voltage"
    voltage_high:
      name: "Battery15 Highest Cell Voltage"

# --- Web Terminal ---
# This creates a text box on the web page.
# Any text you type here is sent directly to the battery.
# text:
#   - platform: template
#     name: "Console Command"
#     icon: "mdi:console-line"
#     mode: text
#     optimistic: true # Required to handle input updates automatically
#     # When you press Enter in the web UI:
#     on_value:
#       then:
#         - logger.log: 
#             format: "Sending manual command: %s"
#             args: [ 'x.c_str()' ]
#         - uart.write:
#             id: uart_bus
#             # We append a newline (\n) automatically. 
#             # If the battery specifically needs \r, change this to: return x + "\r";
#             data: !lambda |
#               std::string s = x + "\n";
#               return std::vector<unsigned char>(s.begin(), s.end());

#This button in home assistant allows for an immediate update otherwise it will wait the duration
button:
  - platform: template
    name: "Force Update (PWR)"
    icon: "mdi:refresh"
    on_press:
      - logger.log: "Sending Force PWR command"
      - uart.write:
          id: uart_bus
          data: "pwr\n"
